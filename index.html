<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroSoma | Play-to-Heal</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --bg-color: #0a0f14;
            --neon-green: #00ff9d;
            --neon-cyan: #00f3ff;
            --alert-orange: #ff5e00;
            --text-main: #e0e0e0;
            --glass: rgba(20, 25, 30, 0.7);
            --border-radius: 16px;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
        }

        /* 3D Canvas Background */
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            pointer-events: none; /* –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–ª–∏–∫–∏ –∫ –∫–∞–Ω–≤–∞—Å—É, –≥–¥–µ –Ω–µ—Ç –∫–Ω–æ–ø–æ–∫ */
        }

        .pointer-events-auto {
            pointer-events: auto;
        }

        /* Header */
        header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
        }

        .stats-bar {
            display: flex;
            gap: 10px;
        }

        .stat-pill {
            background: var(--glass);
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            backdrop-filter: blur(10px);
        }

        .currency { color: var(--neon-cyan); font-weight: bold; }
        .stress { color: var(--alert-orange); }

        /* Main Content Area */
        #main-view {
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        h1 {
            font-size: 2rem;
            text-shadow: 0 0 10px var(--neon-green);
            margin-bottom: 5px;
        }

        p.subtitle {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 20px;
        }

        /* Action Panels (Hidden by default) */
        .panel {
            display: none;
            background: var(--glass);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(0, 255, 157, 0.2);
            backdrop-filter: blur(15px);
            width: 90%;
            max-width: 400px;
            animation: slideUp 0.3s ease-out;
            pointer-events: auto;
        }

        .panel.active {
            display: block;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Buttons */
        .btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:active {
            background: var(--neon-green);
            color: #000;
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--neon-green);
            color: #000;
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.4);
        }

        /* Bottom Nav */
        nav {
            background: rgba(10, 15, 20, 0.95);
            padding: 15px 20px 30px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-around;
            pointer-events: auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            opacity: 0.5;
            transition: 0.3s;
            cursor: pointer;
        }

        .nav-item.active {
            opacity: 1;
            color: var(--neon-green);
            text-shadow: 0 0 8px var(--neon-green);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        /* Specific Mechanics Styles */
        
        /* Breath Circle */
        .breath-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 2px solid var(--neon-cyan);
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
        }
        
        @keyframes breathe-anim {
            0% { transform: scale(1); opacity: 0.5; border-color: #fff;} /* Inhale */
            40% { transform: scale(1.5); opacity: 1; border-color: var(--neon-cyan);} /* Hold */
            100% { transform: scale(1); opacity: 0.5; border-color: #fff;} /* Exhale */
        }

        .breathing-active {
            animation: breathe-anim 9s infinite ease-in-out; /* 4+7+8 approx scaled for visuals */
        }

        /* Vision Overlay */
        #vision-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            color: #333;
            flex-direction: column;
        }

        /* Hydration Water Level */
        .water-tank {
            width: 100%;
            height: 150px;
            background: #1a1a1a;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin: 10px 0;
        }
        .water-level {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30%;
            background: linear-gradient(0deg, var(--neon-cyan), #0077ff);
            transition: height 0.5s ease;
            box-shadow: 0 0 20px var(--neon-cyan);
        }

        /* Gyro Simulator (For Desktop Debug) */
        #gyro-sim {
            margin-top: 20px;
            width: 100%;
        }
        .hidden-mobile {
            display: none;
        }
        @media (min-width: 768px) {
            .hidden-mobile { display: block; }
        }

    </style>
</head>
<body>

    <!-- 3D Container -->
    <div id="canvas-container"></div>

    <!-- Vision Rest Overlay -->
    <div id="vision-overlay">
        <div style="font-size: 40px;">üåë</div>
        <p>Eyes closed. Relax.</p>
        <p id="vision-timer">20</p>
    </div>

    <!-- UI Layer -->
    <div id="ui-layer">
        <header class="pointer-events-auto">
            <div class="user-info">
                <div style="font-size: 12px; color: #888;">LVL 4 // NEUROLINK</div>
                <div style="font-weight: bold;">USER_ID_8492</div>
            </div>
            <div class="stats-bar">
                <div class="stat-pill"><span class="currency">‚ö°</span> <span id="energy-val">85%</span></div>
                <div class="stat-pill"><span class="currency">üíé</span> <span id="token-val">420</span></div>
            </div>
        </header>

        <div id="main-view">
            <!-- Avatar Interaction Area (Invisible click zone) -->
            <div style="height: 300px; width: 100%;" class="pointer-events-auto" onclick="tapAvatar()"></div>

            <!-- HOME PANEL -->
            <div id="panel-home" class="panel active">
                <h3>Status: <span style="color: var(--neon-green)">STABLE</span></h3>
                <p class="subtitle">Your NeuroSoma needs alignment.</p>
                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: #888;">Fluidity</div>
                        <div style="color: var(--neon-cyan);" id="stat-fluency">30%</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: #888;">Shield</div>
                        <div style="color: var(--neon-green);" id="stat-shield">50%</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: #888;">Stress</div>
                        <div style="color: var(--alert-orange);" id="stat-stress">Low</div>
                    </div>
                </div>
            </div>

            <!-- BREATH PANEL -->
            <div id="panel-breath" class="panel">
                <h3>Haptic Sync</h3>
                <p class="subtitle">4-7-8 Rhythm to lower cortisol.</p>
                <div class="breath-circle" id="breath-visual">START</div>
                <button class="btn btn-primary" onclick="startBreathingSession()">Start Session</button>
            </div>

            <!-- POSTURE PANEL -->
            <div id="panel-posture" class="panel">
                <h3>Spine Alignment</h3>
                <p class="subtitle">Hold phone vertical (90¬∞) to charge Shield.</p>
                <div style="font-size: 40px; margin: 10px;" id="posture-icon">‚ö†Ô∏è</div>
                <div style="background: #222; height: 10px; border-radius: 5px; overflow: hidden; margin-bottom: 10px;">
                    <div id="posture-bar" style="width: 0%; background: var(--neon-green); height: 100%; transition: width 0.2s;"></div>
                </div>
                <div id="posture-status">Deviated</div>
                
                <!-- Desktop Simulation -->
                <div class="hidden-mobile">
                    <label style="font-size: 10px;">Desktop Sim (Angle):</label>
                    <input type="range" id="gyro-sim" min="0" max="180" value="45" oninput="simulateGyro(this.value)">
                </div>
                
                <button class="btn btn-primary" id="btn-posture" onclick="togglePostureCheck()">Initialize Sensor</button>
            </div>

            <!-- HYDRATION PANEL -->
            <div id="panel-water" class="panel">
                <h3>Hydration Log</h3>
                <p class="subtitle">Increase Fluidity stat.</p>
                <div class="water-tank">
                    <div class="water-level" id="water-visual" style="height: 30%;"></div>
                </div>
                <button class="btn" onclick="addWater()">+250ml Drink</button>
                <button class="btn btn-primary" onclick="alert('Dodge chance increased!')">Sync Data</button>
            </div>

             <!-- VISION PANEL -->
             <div id="panel-vision" class="panel">
                <h3>Digital Detox</h3>
                <p class="subtitle">Blackout for 20 seconds. Rest your eyes.</p>
                <button class="btn btn-primary" onclick="startVisionRest()">Enter Dark Mode</button>
            </div>
        </div>

        <nav>
            <div class="nav-item active" onclick="switchTab('home')">
                <div class="nav-icon">‚¨¢</div>
                <div>Core</div>
            </div>
            <div class="nav-item" onclick="switchTab('breath')">
                <div class="nav-icon">ü´Å</div>
                <div>Breath</div>
            </div>
            <div class="nav-item" onclick="switchTab('posture')">
                <div class="nav-icon">üìê</div>
                <div>Posture</div>
            </div>
            <div class="nav-item" onclick="switchTab('water')">
                <div class="nav-icon">üíß</div>
                <div>Hydrate</div>
            </div>
            <div class="nav-item" onclick="switchTab('vision')">
                <div class="nav-icon">üëÅÔ∏è</div>
                <div>Vision</div>
            </div>
        </nav>
    </div>

    <script>
        // --- TELEGRAM SETUP ---
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // --- GAME STATE ---
        const state = {
            tokens: 420,
            energy: 85,
            hydration: 30,
            stress: 20, // 0-100
            shield: 0,
            isPostureActive: false,
            postureScore: 0
        };

        // --- THREE.JS SETUP ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        
        // Camera
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        // Renderer
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0x00ff9d, 1, 100);
        pointLight.position.set(5, 5, 5);
        scene.add(pointLight);
        const blueLight = new THREE.PointLight(0x00f3ff, 1, 100);
        blueLight.position.set(-5, -5, 5);
        scene.add(blueLight);

        // AVATAR: "NeuroCore"
        // Using an Icosahedron for a tech/crystal look
        const geometry = new THREE.IcosahedronGeometry(1.8, 1);
        const material = new THREE.MeshStandardMaterial({ 
            color: 0x222222, 
            emissive: 0x00ff9d,
            emissiveIntensity: 0.5,
            roughness: 0.2,
            metalness: 0.8,
            wireframe: true
        });
        
        // Inner Core (Glowing)
        const coreGeo = new THREE.SphereGeometry(1, 32, 32);
        const coreMat = new THREE.MeshBasicMaterial({ color: 0x00ff9d });
        const core = new THREE.Mesh(coreGeo, coreMat);
        
        const avatar = new THREE.Mesh(geometry, material);
        avatar.add(core); // Add core inside shell
        scene.add(avatar);

        // Particles Background
        const particlesGeo = new THREE.BufferGeometry();
        const particlesCount = 300;
        const posArray = new Float32Array(particlesCount * 3);
        for(let i = 0; i < particlesCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 15;
        }
        particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const particlesMat = new THREE.PointsMaterial({
            size: 0.03,
            color: 0x00f3ff,
            transparent: true,
            opacity: 0.6
        });
        const particles = new THREE.Points(particlesGeo, particlesMat);
        scene.add(particles);

        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);

            // Avatar Idle Animation
            avatar.rotation.x += 0.002;
            avatar.rotation.y += 0.005;
            
            // Pulse effect based on stress/health
            const time = Date.now() * 0.001;
            const pulse = Math.sin(time * 2) * 0.1 + 1; // Pulse scale
            core.scale.set(pulse, pulse, pulse);

            // Color shift based on state
            if (state.stress > 70) {
                material.emissive.setHex(0xff5e00); // Orange
                coreMat.color.setHex(0xff5e00);
            } else {
                material.emissive.setHex(0x00ff9d); // Green
                coreMat.color.setHex(0x00ff9d);
            }

            // Rotate particles
            particles.rotation.y -= 0.001;

            renderer.render(scene, camera);
        }
        animate();

        // Handle Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });


        // --- UI LOGIC ---

        function switchTab(tabName) {
            // Haptic Feedback
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');

            // Reset Nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Hide all panels
            document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
            
            // Show target panel
            const panel = document.getElementById(`panel-${tabName}`);
            if(panel) panel.classList.add('active');

            // Camera movement for effect
            if(tabName === 'posture') {
                // Zoom out for posture check
                new TWEEN_Camera(7); 
            } else if (tabName === 'breath') {
                new TWEEN_Camera(3);
            } else {
                new TWEEN_Camera(5);
            }
        }

        // Simple camera tween helper
        function TWEEN_Camera(targetZ) {
            // Just a rough smooth movement implementation without external lib
            const step = (targetZ - camera.position.z) * 0.1;
            if (Math.abs(step) > 0.01) {
                camera.position.z += step;
                requestAnimationFrame(() => TWEEN_Camera(targetZ));
            }
        }

        // --- MECHANICS ---

        // 1. Tap Avatar
        function tapAvatar() {
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            
            // Visual reaction
            avatar.rotation.x += 0.5;
            state.tokens += 1;
            updateUI();
        }

        // 2. Breath Work (Haptic Sync)
        let breathingInterval;
        function startBreathingSession() {
            const visual = document.getElementById('breath-visual');
            const btn = document.querySelector('#panel-breath button');
            
            if (visual.classList.contains('breathing-active')) {
                // Stop
                visual.classList.remove('breathing-active');
                visual.innerText = "START";
                btn.innerText = "Start Session";
                clearInterval(breathingInterval);
                return;
            }

            visual.classList.add('breathing-active');
            visual.innerText = "";
            btn.innerText = "Stop Session";

            // 4-7-8 Pattern (Simulated Cycle)
            // Inhale (4s), Hold (7s), Exhale (8s) = 19s cycle
            // Simplified for Demo: 4s In, 4s Out
            
            const cycle = () => {
                visual.innerText = "INHALE";
                if(navigator.vibrate) navigator.vibrate([100, 50, 100, 50]); // Pattern
                
                setTimeout(() => {
                    visual.innerText = "HOLD";
                }, 4000);

                setTimeout(() => {
                    visual.innerText = "EXHALE";
                    if(navigator.vibrate) navigator.vibrate(1000); // Long vibration
                }, 5000); // Shortened for demo UX
            };

            cycle();
            breathingInterval = setInterval(cycle, 9000);
        }

        // 3. Posture Check
        function togglePostureCheck() {
            const btn = document.getElementById('btn-posture');
            
            if (!state.isPostureActive) {
                // Request Permissions for iOS 13+
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                activatePosture();
                            }
                        })
                        .catch(console.error);
                } else {
                    // Android / Non-iOS
                    activatePosture();
                }
            } else {
                // Stop
                window.removeEventListener('deviceorientation', handleOrientation);
                state.isPostureActive = false;
                btn.innerText = "Initialize Sensor";
                document.getElementById('posture-status').innerText = "Sensor Off";
            }
        }

        function activatePosture() {
            window.addEventListener('deviceorientation', handleOrientation);
            state.isPostureActive = true;
            document.getElementById('btn-posture').innerText = "Stop Scanning";
        }

        function handleOrientation(event) {
            // Beta represents front-back motion (-180 to 180).
            // Holding phone vertical is roughly 90 degrees.
            let beta = event.beta; 
            if (!beta) return; // Desktop null check

            processPostureLogic(beta);
        }

        function simulateGyro(val) {
            // For desktop testing
            processPostureLogic(parseInt(val));
        }

        function processPostureLogic(beta) {
            const statusEl = document.getElementById('posture-status');
            const barEl = document.getElementById('posture-bar');
            const iconEl = document.getElementById('posture-icon');

            // Target: 80 to 100 degrees (Vertical)
            const isGood = beta > 80 && beta < 100;

            if (isGood) {
                statusEl.innerText = "PERFECT ALIGNMENT";
                statusEl.style.color = "var(--neon-green)";
                barEl.style.background = "var(--neon-green)";
                iconEl.innerText = "‚úÖ";
                
                // Charge shield
                if(state.shield < 100) {
                    state.shield += 0.5;
                    document.getElementById('stat-shield').innerText = Math.floor(state.shield) + "%";
                    barEl.style.width = state.shield + "%";
                }
            } else {
                statusEl.innerText = "ALIGN SPINE (Hold Vertical)";
                statusEl.style.color = "var(--alert-orange)";
                barEl.style.background = "var(--alert-orange)";
                iconEl.innerText = "‚ö†Ô∏è";
            }
        }

        // 4. Hydration
        function addWater() {
            if(state.hydration < 100) {
                state.hydration += 10;
                document.getElementById('water-visual').style.height = state.hydration + "%";
                document.getElementById('stat-fluency').innerText = state.hydration + "%";
                if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('heavy');
                
                // Visual Splash effect via 3D color
                coreMat.color.setHex(0x00f3ff); // Cyan flash
                setTimeout(() => coreMat.color.setHex(0x00ff9d), 500);
            }
        }

        // 5. Vision Rest
        function startVisionRest() {
            const overlay = document.getElementById('vision-overlay');
            const timerEl = document.getElementById('vision-timer');
            overlay.style.display = 'flex';
            
            let timeLeft = 20;
            timerEl.innerText = timeLeft;

            const timer = setInterval(() => {
                timeLeft--;
                timerEl.innerText = timeLeft;
                
                if(timeLeft <= 0) {
                    clearInterval(timer);
                    overlay.style.display = 'none';
                    state.tokens += 50; // Reward
                    updateUI();
                    alert("Vision Restored! +50 NEURO");
                }
            }, 1000);
        }

        // Utility
        function updateUI() {
            document.getElementById('token-val').innerText = state.tokens;
            document.getElementById('energy-val').innerText = state.energy + "%";
        }

    </script>
</body>
</html>